# 神经网络测试数据多样性度量工具

## 系统整体概述 

神经网络测试数据多样性度量工具一种用于衡量深度神经网络(DNN)测试数据多样性程度的工具。为了评估和改进神经网络的性能，需要使用足够充分的测试数据集进行训练和测试。该工具可以帮助开发人员和测试人员度量测试数据集的多样性，从而可以更全面地了解网络的行为和预测其在真实环境中的表现

该工具基于一种三角形投影的多样性度量方法（pt），通过将DNN模型的高维输出域投影到低维的三角形子空间中，并在基于三角形子空间计算覆盖程度，称作Pt分数，用于评估DNN模型输出的多样性。

## 系统模块

| 模块名称         | 介绍                                             |
| ---------------- | ------------------------------------------------ |
| 输入模块         | 接受系统输入，包含数据，模型，和算法参数信息     |
| 子空间域分割模块 | 将高维空间划分为低维子空间                       |
| 数据降维模块     | 根据高维向量和子空间域计算某个测试用例的低维向量 |
| 多样性计算模块   | 根据测试用例集的投影位置集合计算多样性指标       |

**输入模块**：负责收集待测DNN系统的基本信息，检验是否符合工具使用条件。输入信息包含待评估测试数据集，待评估模型，模型分类任务的分类总数，多样性度量算法中分区次数参数。

**子空间域分割模块**：对于每个独立的信息片段所对应的数据分布子域，设计子空间分割算法。给定空间维度n>=3，该模块将n维的空间分成多个3维的三角形子空间平面。接下来，给定分区次数m，该模块将子空间执行m次分块操作，将子空间分割成多个分块区域。

**数据降维模块**：该模块提取模型在低维空间中可处理的低维信息，获取更低维度可操作输出信息片段，对输出结果进行降维分析。给定测试用例的高维输出向量和子空间集合，该模块通过投影降维计算每个子空间下的低维向量，获取更低维度可操作输出信息片段。

**多样性计算模块**：该模块通过计算有多少子空间分块区域被覆盖，来判断输出数据的信息片段在当前子域下的覆盖情况，子空间分块区域被覆盖越多，则多样性程度越高。给定测试数据集合中每个测试的低维度可操作输出信息片段集合，该模块通过多样性计算算法，计算测试套件集合的多样性程度。

**适用范围**

本工具适用于图像分类任务

## 示例

**例1：子空间域分割模块**

![img](https://openi.pcl.ac.cn/niangao/PTtool/raw/branch/master/src/example1.png) 

上图展示了子空间域分割模块中的子空间分割功能，给定分区次数m=2，该模块对子空间执行两次分割操作，每次分割将子空间划分为原来的四倍，并对每个子空间分块区域进行顺序编号。

**例2：多样性计算模块**

![img](https://openi.pcl.ac.cn/niangao/PTtool/raw/branch/master/src/example2.jpg) 

上图展示了子多样性计算模块中的多样性计算功能，给定三个测试用例t1,t2,t3、空间维度n=4、和分区次数m=3，子空间域分割模块将每个三角形边划分为16个子空间分块三角形。数据降维模块将每个测试的高维向量计算为多个低维度可操作输出信息片段（第二列）。多样性计算模块根据上述信息，计算每个子空间内的子空间分块三角形的投影位置（第三列），并汇总所有测试的覆盖信息计算每个子空间的覆盖程度（第四列），最后计算出数据多样性。

## **环境要求**

本工具基于python3.6和tensorflow1.x开发，其中Keras 版本不低于2.3.1，TensorFlow 版本不低于1.13.1.

**手动配置环境**

1. 选择tensorflow 2.2官方镜像

2. 安装包

   ```
   pip install fire
   pip install keras==2.3.1
   pip install prettytable
   pip install tqdm
   ```

**复制镜像地址**

```
docker镜像地址 ：dockerhub.pcl.ac.cn:5000/user-images/openi:PTtools_v1.0.0
```

## 使用方法

1. 跳转到代码目录

   ```
   cd /code
   ```

2. 运行命令行

   ```bash
   Python tools.py  --model_path {p1} --data_path {p2} --class_num {n} --split_num {m}
   ```

   **参数说明**

   - **model_path**: 模型路径
   - **data_path**: 数据集路径
   - **class_num**: 模型分类任务数
   - **split_num**: 子空间划分次数

   **示例**

   1. 运行命令行

      ```
      cd /code
      ```

      ```bash
      python tools.py --split_num 4 --class_num 10 --data_path "data/mnist" --model_path "model/model_mnist_LeNet5.hdf5"
      ```

   2. 输出结果

      "Data Diverstiy" 代表多样性数值，其越接近于1越好。"Detail Result"输出了对应每一次子空间划分时的数据多样性度量指标，“Deep”值越大则粒度越细。

      ```
      Data Diverstiy: 0.01954, Model: model/model_mnist_LeNet5.hdf5, Data: data/mnist
      Detail Result
      +------+-----------+
      | Deep | Diversity |
      +------+-----------+
      |  1   |  0.98889  |
      |  2   |  0.26024  |
      |  3   |  0.07574  |
      |  4   |  0.01954  |
      +------+-----------+
      ```

   

 